import * as request from "request";

export class MythX {
    public apiUrl: string;

    constructor() {
        this.apiUrl = process.env.MYTHX_API_URL || 'https://api.mythx.io/v1';
    }

    private makePostRequest(url, options) {
        return new Promise((resolve, reject) => {
            request.post(url, options, (error, res, body) => {
                if (error) {
                    reject(error);
                }

                try {
                    if (res.statusCode === 200) {
                        resolve(JSON.parse(body));
                    } else {
                        reject(body);
                    }
                } catch (error) {
                    reject(error.message);
                }
            });
        });
    }

    public refreshTokenRequest(access: string, refresh: string): Promise<{ access: string, refresh: string }> {
        const url = `${this.apiUrl}/auth/refresh`;
        const options = {
            form: {
                jwtTokens: {access, refresh},
            },
        };

        return this.makePostRequest(url, options) as Promise<{ access: string, refresh: string }>;
    }

    public submitContractForFullAnalysis(compilationOutput, source, contractName, access) {
        const fullName = contractName.includes('.sol') ? contractName : `${contractName}.sol`;
        const url = `${this.apiUrl}/analyses`;
        const data = {
            ...compilationOutput,
            analysisMode : "quick",
            sources: {
                [fullName] : {
                    source: JSON.parse(source),
                }
            },
            mainSource: fullName,
        };

        const options = {
            headers: {
                'Authorization': `Bearer ${access}`,
            },
            form: { data, clientToolName: 'vulnerability-monitor' }
        };

        return this.makePostRequest(url, options);
    }

    public submitContractForBytecodeAnalysis(bytecode, access) {
        const url = `${this.apiUrl}/analyses`;
        const data = {
            bytecode,
        };

        const options = {
            headers: {
                'Authorization': `Bearer ${access}`,
            },
            form: { data }
        };

        return this.makePostRequest(url, options);
    }
}

export default new MythX();
