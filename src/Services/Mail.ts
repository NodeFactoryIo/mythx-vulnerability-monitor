import * as mailgun from 'mailgun-js';
import * as fs from 'fs';
import * as path from 'path';

class Mail {
    mg: mailgun;

    constructor() {
        const env = process.env;
        if (!env.MG_DOMAIN || !env.MG_API_KEY) {
            throw new Error('Mailgun environment settings not set')
        }

        this.mg = mailgun({ apiKey: env.MG_API_KEY, domain: env.MG_DOMAIN });
    }

    sendReport(to, data) {
        const { reportURL } = data;

        const html = fs.readFileSync(path.resolve(__dirname,'../Assets/email-report.html')).toString();
        const maildata = {
            to,
            from: process.env.MG_FROM || 'analysis@vulnerability-monitor.nodefactory.io',
            subject: "MythX vulnerability monitor results",
            html,
            'v:reportURL': reportURL,
        };

        return new Promise((resolve, reject) => {
            this.mg.messages().send(maildata, function (error, body) {
                error ? reject(error) : resolve(body);
            });
        });
    }
}

export default new Mail();
